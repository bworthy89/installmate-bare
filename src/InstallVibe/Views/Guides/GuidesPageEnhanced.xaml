<Page
    x:Class="InstallVibe.Views.Guides.GuidesPageEnhanced"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:vm="using:InstallVibe.ViewModels.Guides"
    xmlns:controls="using:InstallVibe.Controls"
    mc:Ignorable="d"
    Background="{ThemeResource ApplicationPageBackgroundThemeBrush}"
    Loaded="Page_Loaded">

    <Page.Resources>
        <Storyboard x:Name="PageEntranceStoryboard">
            <DoubleAnimation Storyboard.TargetName="ContentRoot"
                           Storyboard.TargetProperty="Opacity"
                           From="0" To="1" Duration="0:0:0.3"/>
        </Storyboard>
    </Page.Resources>

    <Grid x:Name="ContentRoot" Padding="32">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Header with Connection Status -->
        <Grid Grid.Row="0" Margin="0,0,0,24">
            <TextBlock Text="Installation Guides"
                      FontSize="32"
                      FontWeight="Bold"/>
            <controls:ConnectionStatusIndicator x:Name="ConnectionStatus"
                                              HorizontalAlignment="Right"
                                              VerticalAlignment="Center"/>
        </Grid>

        <!-- Resume Last Guide Panel -->
        <controls:ResumeGuidePanel Grid.Row="1"
                                  x:Name="ResumePanel"
                                  HasLastGuide="{x:Bind ViewModel.HasLastGuide, Mode=OneWay}"
                                  LastGuideTitle="{x:Bind ViewModel.LastGuideTitle, Mode=OneWay}"
                                  LastGuideStep="{x:Bind ViewModel.LastGuideStep, Mode=OneWay}"
                                  LastGuideTotalSteps="{x:Bind ViewModel.LastGuideTotalSteps, Mode=OneWay}"
                                  LastGuideProgress="{x:Bind ViewModel.LastGuideProgress, Mode=OneWay}"
                                  ResumeCommand="{x:Bind ViewModel.ResumeLastGuideCommand}"/>

        <!-- Search and Filter Bar -->
        <Grid Grid.Row="2" Margin="0,0,0,20">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <!-- Enhanced Search Box -->
            <AutoSuggestBox Grid.Column="0"
                           PlaceholderText="Search guides by title or description..."
                           Text="{x:Bind ViewModel.SearchText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                           QueryIcon="Find"
                           Height="48"
                           FontSize="16"
                           VerticalAlignment="Center"
                           Margin="0,0,16,0"/>

            <!-- Filter Button -->
            <Button Grid.Column="1"
                    Height="48"
                    Width="48"
                    Margin="0,0,12,0"
                    ToolTipService.ToolTip="Filter guides">
                <SymbolIcon Symbol="Filter" FontSize="18"/>
                <Button.Flyout>
                    <MenuFlyout Placement="BottomEdgeAlignedRight">
                        <MenuFlyoutSubItem Text="Category">
                            <MenuFlyoutItem Text="All Categories" Click="FilterCategory_Click" Tag=""/>
                            <MenuFlyoutSeparator/>
                            <MenuFlyoutItem Text="Hardware" Click="FilterCategory_Click" Tag="Hardware"/>
                            <MenuFlyoutItem Text="Software" Click="FilterCategory_Click" Tag="Software"/>
                            <MenuFlyoutItem Text="Network" Click="FilterCategory_Click" Tag="Network"/>
                            <MenuFlyoutItem Text="System" Click="FilterCategory_Click" Tag="System"/>
                        </MenuFlyoutSubItem>
                        <MenuFlyoutSeparator/>
                        <MenuFlyoutSubItem Text="Sort By">
                            <MenuFlyoutItem Text="Title (A-Z)" Click="SortBy_Click" Tag="TitleAsc"/>
                            <MenuFlyoutItem Text="Title (Z-A)" Click="SortBy_Click" Tag="TitleDesc"/>
                            <MenuFlyoutItem Text="Recently Updated" Click="SortBy_Click" Tag="Updated"/>
                            <MenuFlyoutItem Text="Most Popular" Click="SortBy_Click" Tag="Popular"/>
                        </MenuFlyoutSubItem>
                    </MenuFlyout>
                </Button.Flyout>
            </Button>

            <!-- Refresh Button -->
            <Button Grid.Column="2"
                    Command="{x:Bind ViewModel.RefreshGuidesCommand}"
                    Height="48"
                    MinWidth="120"
                    FontSize="16"
                    ToolTipService.ToolTip="Refresh guides (F5)">
                <StackPanel Orientation="Horizontal" Spacing="10">
                    <SymbolIcon Symbol="Refresh" FontSize="18"/>
                    <TextBlock Text="Refresh" FontWeight="SemiBold"/>
                </StackPanel>
            </Button>
        </Grid>

        <!-- Active Filters Display -->
        <ItemsRepeater Grid.Row="3"
                      x:Name="ActiveFilters"
                      Margin="0,0,0,16"
                      Visibility="Collapsed">
            <ItemsRepeater.Layout>
                <StackLayout Orientation="Horizontal" Spacing="8"/>
            </ItemsRepeater.Layout>
            <ItemsRepeater.ItemTemplate>
                <DataTemplate>
                    <Border Background="{ThemeResource AccentFillColorDefaultBrush}"
                            CornerRadius="12"
                            Padding="12,6">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <TextBlock Text="{Binding}"
                                      FontSize="14"
                                      Foreground="{ThemeResource TextOnAccentFillColorPrimaryBrush}"/>
                            <Button Width="20"
                                   Height="20"
                                   Padding="0"
                                   Background="Transparent"
                                   BorderThickness="0">
                                <FontIcon Glyph="&#xE711;"
                                         FontSize="10"
                                         Foreground="{ThemeResource TextOnAccentFillColorPrimaryBrush}"/>
                            </Button>
                        </StackPanel>
                    </Border>
                </DataTemplate>
            </ItemsRepeater.ItemTemplate>
        </ItemsRepeater>

        <!-- Content Area -->
        <Grid Grid.Row="4">
            <!-- Loading Skeletons -->
            <ItemsRepeater x:Name="LoadingSkeletons"
                          Visibility="{x:Bind ViewModel.IsLoading, Mode=OneWay}">
                <ItemsRepeater.ItemTemplate>
                    <DataTemplate>
                        <ContentControl ContentTemplate="{StaticResource GuideCardSkeletonTemplate}"/>
                    </DataTemplate>
                </ItemsRepeater.ItemTemplate>
            </ItemsRepeater>

            <!-- Error State -->
            <InfoBar Severity="Error"
                    Title="Error Loading Guides"
                    Message="{x:Bind ViewModel.ErrorMessage, Mode=OneWay}"
                    IsOpen="{x:Bind ViewModel.HasError, Mode=OneWay}"
                    IsClosable="True"
                    Visibility="{x:Bind ViewModel.HasError, Mode=OneWay}"
                    VerticalAlignment="Top"/>

            <!-- Guides List with Enhanced Cards -->
            <ScrollViewer VerticalScrollBarVisibility="Auto"
                         Visibility="{x:Bind ViewModel.IsLoading, Mode=OneWay, Converter={StaticResource InverseBoolToVisibilityConverter}}">
                <ItemsRepeater ItemsSource="{x:Bind ViewModel.FilteredGuides, Mode=OneWay}"
                              Margin="0,0,0,24">
                    <ItemsRepeater.ItemTemplate>
                        <DataTemplate>
                            <Button Command="{Binding DataContext.OpenGuideCommand, ElementName=Page}"
                                   CommandParameter="{Binding}"
                                   HorizontalAlignment="Stretch"
                                   HorizontalContentAlignment="Stretch"
                                   Padding="0"
                                   Margin="0,0,0,16"
                                   Background="Transparent"
                                   BorderThickness="0"
                                   CornerRadius="8">
                                <Button.RenderTransform>
                                    <ScaleTransform/>
                                </Button.RenderTransform>
                                <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                                       BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                       BorderThickness="1"
                                       CornerRadius="8"
                                       Padding="24"
                                       MinHeight="140">
                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>

                                        <!-- Title - Larger -->
                                        <TextBlock Grid.Row="0"
                                                  Text="{Binding Metadata.Title}"
                                                  FontSize="22"
                                                  FontWeight="SemiBold"
                                                  TextWrapping="Wrap"
                                                  Margin="0,0,0,12"/>

                                        <!-- Description - Larger -->
                                        <TextBlock Grid.Row="1"
                                                  Text="{Binding Metadata.Description}"
                                                  FontSize="16"
                                                  TextWrapping="Wrap"
                                                  MaxLines="2"
                                                  Opacity="0.8"
                                                  LineHeight="24"
                                                  Margin="0,0,0,16"/>

                                        <!-- Metadata - Larger Icons and Text -->
                                        <StackPanel Grid.Row="2" Orientation="Horizontal" Spacing="20">
                                            <StackPanel Orientation="Horizontal" Spacing="8">
                                                <FontIcon Glyph="&#xE8FD;" FontSize="18" Opacity="0.7"/>
                                                <TextBlock FontSize="15" Opacity="0.7">
                                                    <Run Text="{Binding Steps.Count}"/>
                                                    <Run Text="steps"/>
                                                </TextBlock>
                                            </StackPanel>
                                            <StackPanel Orientation="Horizontal" Spacing="8">
                                                <FontIcon Glyph="&#xE823;" FontSize="18" Opacity="0.7"/>
                                                <TextBlock Text="{Binding Metadata.Version}"
                                                          FontSize="15"
                                                          Opacity="0.7"/>
                                            </StackPanel>
                                        </StackPanel>
                                    </Grid>
                                </Border>
                            </Button>
                        </DataTemplate>
                    </ItemsRepeater.ItemTemplate>
                </ItemsRepeater>
            </ScrollViewer>

            <!-- Empty State -->
            <StackPanel HorizontalAlignment="Center"
                       VerticalAlignment="Center"
                       Spacing="16"
                       Visibility="{x:Bind ViewModel.FilteredGuides.Count, Mode=OneWay, Converter={StaticResource ZeroToVisibilityConverter}}">
                <FontIcon Glyph="&#xE8F1;" FontSize="64" Opacity="0.4"/>
                <TextBlock Text="No guides available"
                          FontSize="20"
                          FontWeight="SemiBold"
                          Opacity="0.6"/>
                <Button Command="{x:Bind ViewModel.RefreshGuidesCommand}"
                       Height="48"
                       MinWidth="140"
                       FontSize="16">
                    <StackPanel Orientation="Horizontal" Spacing="10">
                        <SymbolIcon Symbol="Refresh" FontSize="18"/>
                        <TextBlock Text="Refresh" FontWeight="SemiBold"/>
                    </StackPanel>
                </Button>
            </StackPanel>
        </Grid>
    </Grid>
</Page>
