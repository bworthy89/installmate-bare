<Page
    x:Class="InstallVibe.Views.Guides.GuideDetailPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:vm="using:InstallVibe.ViewModels.Guides"
    mc:Ignorable="d"
    Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header with Progress -->
        <Grid Grid.Row="0"
              Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
              Padding="24"
              BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
              BorderThickness="0,0,0,1">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- Guide Title -->
            <TextBlock Grid.Row="0"
                       Text="{x:Bind ViewModel.Guide.Metadata.Title, Mode=OneWay}"
                       Style="{StaticResource TitleTextBlockStyle}"
                       Margin="0,0,0,12"/>

            <!-- Progress Info -->
            <StackPanel Grid.Row="1" Orientation="Horizontal" Spacing="12" Margin="0,0,0,8">
                <TextBlock Opacity="0.8">
                    <Run Text="Step"/>
                    <Run Text="{x:Bind ViewModel.CurrentStepIndex, Mode=OneWay}"/>
                    <Run Text="of"/>
                    <Run Text="{x:Bind ViewModel.TotalSteps, Mode=OneWay}"/>
                </TextBlock>
                <TextBlock Text="|" Opacity="0.4"/>
                <TextBlock Opacity="0.8">
                    <Run Text="{x:Bind ViewModel.ProgressPercentage, Mode=OneWay}"/>
                    <Run Text="% Complete"/>
                </TextBlock>
            </StackPanel>

            <!-- Progress Bar -->
            <ProgressBar Grid.Row="2"
                         Value="{x:Bind ViewModel.ProgressPercentage, Mode=OneWay}"
                         Maximum="100"
                         ShowError="False"
                         ShowPaused="False"/>
        </Grid>

        <!-- Step Content -->
        <ScrollViewer Grid.Row="1" Padding="24" VerticalScrollBarVisibility="Auto">
            <StackPanel Spacing="24">
                <!-- Error Message -->
                <InfoBar Severity="Error"
                         Message="{x:Bind ViewModel.ErrorMessage, Mode=OneWay}"
                         IsOpen="{x:Bind ViewModel.ErrorMessage, Mode=OneWay, Converter={StaticResource StringToBoolConverter}}"
                         IsClosable="True"
                         Visibility="{x:Bind ViewModel.ErrorMessage, Mode=OneWay, Converter={StaticResource StringToVisibilityConverter}}"/>

                <!-- Loading State -->
                <ProgressRing IsActive="{x:Bind ViewModel.IsLoading, Mode=OneWay}"
                              Width="60"
                              Height="60"
                              HorizontalAlignment="Center"
                              Visibility="{x:Bind ViewModel.IsLoading, Mode=OneWay}"/>

                <!-- Step Content -->
                <StackPanel Spacing="16"
                            Visibility="{x:Bind ViewModel.IsLoading, Mode=OneWay, Converter={StaticResource InverseBoolToVisibilityConverter}}">
                    <!-- Step Title -->
                    <TextBlock Text="{x:Bind ViewModel.CurrentStep.Title, Mode=OneWay}"
                               Style="{StaticResource SubtitleTextBlockStyle}"/>

                    <!-- Step Description -->
                    <TextBlock Text="{x:Bind ViewModel.CurrentStep.Description, Mode=OneWay}"
                               Style="{StaticResource BodyTextBlockStyle}"
                               TextWrapping="Wrap"/>

                    <!-- Step Instructions -->
                    <RichTextBlock TextWrapping="Wrap"
                                   Margin="0,8,0,0">
                        <!-- Instructions will be data-bound or generated dynamically -->
                    </RichTextBlock>

                    <!-- Media Content (if available) -->
                    <Border CornerRadius="8"
                            BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                            BorderThickness="1"
                            Padding="0"
                            Margin="0,16,0,0"
                            Visibility="{x:Bind ViewModel.CurrentStep.MediaReferences.Count, Mode=OneWay, Converter={StaticResource ZeroToVisibilityConverter}}">
                        <Image Source="{x:Bind ViewModel.CurrentStep.MediaReferences[0].Url, Mode=OneWay}"
                               Stretch="UniformToFill"
                               MaxHeight="400"/>
                    </Border>

                    <!-- Checklist Items (if available) -->
                    <ItemsRepeater ItemsSource="{x:Bind ViewModel.CurrentStep.ChecklistItems, Mode=OneWay}"
                                   Margin="0,16,0,0">
                        <ItemsRepeater.ItemTemplate>
                            <DataTemplate>
                                <CheckBox Content="{Binding Text}"
                                          IsChecked="{Binding IsCompleted, Mode=TwoWay}"
                                          Margin="0,0,0,8"/>
                            </DataTemplate>
                        </ItemsRepeater.ItemTemplate>
                    </ItemsRepeater>

                    <!-- Mark Complete Button -->
                    <Button Command="{x:Bind ViewModel.MarkStepCompleteCommand}"
                            HorizontalAlignment="Left"
                            Margin="0,16,0,0">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <SymbolIcon Symbol="Accept"/>
                            <TextBlock Text="Mark Step Complete"/>
                        </StackPanel>
                    </Button>
                </StackPanel>

                <!-- Completion State -->
                <StackPanel Spacing="16"
                            HorizontalAlignment="Center"
                            Visibility="{x:Bind ViewModel.IsCompleted, Mode=OneWay}">
                    <SymbolIcon Symbol="Accept" FontSize="64" Foreground="{ThemeResource SystemAccentColor}"/>
                    <TextBlock Text="Guide Completed!"
                               Style="{StaticResource TitleTextBlockStyle}"
                               HorizontalAlignment="Center"/>
                    <TextBlock Text="You have successfully completed this installation guide."
                               Style="{StaticResource BodyTextBlockStyle}"
                               HorizontalAlignment="Center"
                               Opacity="0.8"/>
                </StackPanel>
            </StackPanel>
        </ScrollViewer>

        <!-- Navigation Footer -->
        <Grid Grid.Row="2"
              Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
              Padding="24"
              BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
              BorderThickness="0,1,0,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <!-- Previous Button -->
            <Button Grid.Column="0"
                    Command="{x:Bind ViewModel.PreviousStepCommand}"
                    IsEnabled="{x:Bind ViewModel.CanNavigatePrevious, Mode=OneWay}"
                    Margin="0,0,12,0">
                <StackPanel Orientation="Horizontal" Spacing="8">
                    <SymbolIcon Symbol="Back"/>
                    <TextBlock Text="Previous"/>
                </StackPanel>
            </Button>

            <!-- Cancel Button -->
            <Button Grid.Column="1"
                    Command="{x:Bind ViewModel.CancelCommand}"
                    HorizontalAlignment="Center">
                <StackPanel Orientation="Horizontal" Spacing="8">
                    <SymbolIcon Symbol="Cancel"/>
                    <TextBlock Text="Cancel"/>
                </StackPanel>
            </Button>

            <!-- Next/Complete Button -->
            <Button Grid.Column="2"
                    Command="{x:Bind ViewModel.NextStepCommand}"
                    IsEnabled="{x:Bind ViewModel.CanNavigateNext, Mode=OneWay}"
                    Style="{StaticResource AccentButtonStyle}">
                <StackPanel Orientation="Horizontal" Spacing="8">
                    <TextBlock>
                        <Run Text="{x:Bind ViewModel.IsCompleted, Mode=OneWay, Converter={StaticResource BoolToStringConverter}, ConverterParameter='Complete|Next'}"/>
                    </TextBlock>
                    <SymbolIcon Symbol="Forward"/>
                </StackPanel>
            </Button>
        </Grid>
    </Grid>
</Page>
